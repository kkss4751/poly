<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>비밀번호 찾기</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- 나의 스타일 추가 -->
    <link rel="stylesheet" href="/css/login.css?v=1234">


    <!-- ===============================================-->
    <!--    Document Title-->
    <!-- ===============================================-->
    <title>Clickr | Landing, Ecommerce &amp; Business Templatee</title>


    <!-- ===============================================-->
    <!--    Favicons-->
    <!-- ===============================================-->
    <link rel="apple-touch-icon" sizes="180x180" href="../clickr/public/assets/img/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../clickr/public/assets/img/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../clickr/public/assets/img/favicons/favicon-16x16.png">
    <link rel="shortcut icon" type="image/x-icon" href="../clickr/public/assets/img/favicons/favicon.ico">
    <link rel="manifest" href="../clickr/public/assets/img/favicons/manifest.json">
    <meta name="msapplication-TileImage" content="../clickr/public/assets/img/favicons/mstile-150x150.png">
    <meta name="theme-color" content="#ffffff">


    <!-- ===============================================-->
    <!--    Stylesheets-->
    <!-- ===============================================-->
    <link href="../clickr/public/assets/css/theme.css" rel="stylesheet"/>

    <link href="../clickr/public/vendors/swiper/swiper-bundle.min.css" rel="stylesheet">

    <style>
        .placeholder-small{
            font-size: 12px;
        }
    </style>
</head>
<body class="text-center" data-bs-target="#navbar">
<!--================================================== -->
<!--     Navbar 고정 -->
<!--================================================== -->
<main class="main" id="top">
    <nav class="navbar navbar-expand-lg navbar-light fixed-top py-3 d-block"
         data-navbar-on-scroll="data-navbar-on-scroll" style="background-color: #FFFFFF">
        <div class="container"><a class="navbar-brand d-inline-flex" href="/main/index"><img class="card-img"
                                                                                             src="../clickr/public/assets/img/gallery/logo.png"
                                                                                             alt="..."/><span
                class="fs-2 fw-bold text-primary ms-2">CLICK<span class="text-warning">R</span></span></a>
            <button class="navbar-toggler collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse border-top border-lg-0 mt-4 mt-lg-0" id="navbarSupportedContent">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item px-2"><a class="nav-link fw-bold" aria-current="page"
                                                 href="/main/index">Home</a></li>
                    <li class="nav-item px-2"><a class="nav-link fw-bold" href="/main/index#search">검색</a></li>
                    <li class="nav-item px-2"><a class="nav-link fw-bold" href="/main/index#usedMedicine">자주먹는 약</a>
                    </li>
                    <li class="nav-item px-2"><a class="nav-link fw-bold" href="/main/index#packages">나의 구급상자</a></li>
                    <li class="nav-item px-2"><a class="nav-link fw-bold" href="/main/index#faqs">FAQs </a></li>
                </ul>
                <form class="ms-lg-5"><a class="btn btn-primary" href="/login/loginForm">Login</a></form>
            </div>
        </div>
    </nav>
</main>
<!--================================================== -->
<!--     Navbar 고정 여기까지 -->
<!--================================================== -->


<!--  html 전체 영역을 지정하는 container -->
<div id="container">
    <!--  login 폼 영역을 : loginBox -->
    <div id="loginBox">

        <form method="post" action="/login/find_pwd/check_user">
            <!-- 로그인 페이지 타이틀 -->
            <div id="loginBoxTitle">FIND PASSWORD</div>
            <!-- 아이디, 비번, 버튼 박스 -->
            <div id="inputBox">
                <div class="input-form-box"><span> User Email </span></div>
                <div class="input-form-box">
                    <input type="text" placeholder="이메일을 입력해주세요." id="uEmail" name="uEmail" class="form-control"
                           style="float: left; width: 70%;">
                    <button type="button" class="btn btn-primary btn-xs" id="sendCodeBtn"
                            style="width: 33%; height: 40px; margin-left: 3%; float:right;" value="이메일 확인"> 이메일 확인
                    </button>
                </div>
                <!-- 인증번호 인증 하면 사라지게 -->
                <div style="display: none;" id="codeCheckDiv">
                    <div class="input-form-box" id="emailCode" style="height: 30px; margin-top: 5px;">
                        <span> Code Check </span></div>
                    <div class="input-form-box">
                        <input type="password" class="form-control placeholder-small" id="mailCode" name="인증번호"
                               style="float: left; width: 55%;" placeholder="인증번호를 입력해주세요.">
                        <button type="button" class="btn btn-primary btn-xs" id="codeCheckBtn"
                                style="width: 50%; height: 40px; margin-left: 3%; float: right"> 인증번호 확인
                        </button>
                    </div>
                </div>

                <!-- 새로운 비밀번호 창 나오기 -->
                <div style="display: none" id="newPwdDiv">
                    <div class=input-form-box>
                        <span> New PassWord</span>
                    </div>
                    <div class="input-form-box">
                        <input type="password" id="pwd1" class="form-control" style="width: 100%" placeholder="새로 사용하실 비밀번호를 입력해주세요">
                    </div>
                    <div class="input-form-box">
                        <input type="password" id="pwd2" class="form-control" style="width: 100%" placeholder="비밀번호를 확인해주세요.">
                    </div>
                    <div class="button-login-box">
                        <button type="button" class="btn btn-primary btn-xs"
                                style="width:100%; height: 45px; margin-top: 22px;" value="비밀번호 찾기"
                                id="pwdFindBtn"> 비밀번호 변경하기
                        </button>
                    </div>
                </div>

                <div><hr>
                    <small><a href="/signup/signupForm" style="text-decoration: underline;  "> * 회원가입 </a> </small>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <small><a href="/login/find_id" style="text-decoration: underline; "> * 아이디 찾기 </a> </small>
                </div>

            </div>
        </form>

    </div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>

    /** 이메일 인증코드 보내기 */

    let randomCode = '';

    $("#sendCodeBtn").click(function () {

        let userEmail = $("#uEmail").val();
        if (userEmail === "") {
            alert("이메일을 입력해주세요");
            $("#uEmail").focus();
            return;
        }

        //랜덤코드 만들기
        function randomString() {
            const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz'
            const stringLength = 8
            let randomstring = ''
            for (let i = 0; i < stringLength; i++) {
                const rnum = Math.floor(Math.random() * chars.length)
                randomstring += chars.substring(rnum, rnum + 1)
            }
            return randomstring
        }

        randomCode = randomString();

        $.ajax({
            type: "POST",
            url: "/login/pwdCodeSend",
            data: {"userEmail": userEmail, "mailCode": randomCode},
            success: function (data) {

                if (data.code === 1) {
                    alert(" 성공적으로 코드가 발송되었습니다 ")
                    document.getElementById("uEmail").readOnly = true;
                    $("#codeCheckDiv").css("display", "block");
                } else {
                    alert(" 존재하지 않는 회원입니다. \n\n 다시한번 확인해주세요. ")
                }
            },
            error: function () {
                alert("통신 실패")
            }
        });
    });


    /** 이메일 인증하기 인증시 코드는 숨기고 비밀번호 변경 버튼 나오게 */
    $("#codeCheckBtn").click(function () {
        if ($("#mailCode").val() === "") {
            alert("인증번호를 입력해주세요");
            return S("#mailCode").focus();
        } else if ($("#mailCode").val() === randomCode) {
            alert("정상적으로 확인되었습니다 \n\n 새로운 비밀번호를 입력해주세요.")

            document.getElementById("sendCodeBtn").disabled = true;
            document.getElementById("codeCheckBtn").disabled = true;

            $("#newPwdDiv").css("display", "block");
        } else {
            alert("인증번호를 다시한번 확인해주세요.")
        }
        ;

    })

    /** 비밀번호 일치 확인 */
    $("#pwdFindBtn").click(function (){


        let userEmail = $("#uEmail").val();
        let newPwd = $("#pwd1").val();

        if ($("#pwd1").val() === ""){
            alert("새로운 비밀번호를 입력해주세요.");
            return document.getElementById("pwd1").focus();

        }else if ($("#pwd2").val() === ""){
            alert("비밀번호를 확인창을 채워주세요");
            return document.getElementById("pwd2").focus();

        }

        if( $("#pwd1").val() !== $("#pwd2").val()){
            alert("비밀번호가 일치하지 않습니다. \n\n 다시한번 확인해주세요")
            document.getElementById("pwd1").value = "";
            document.getElementById("pwd2").value = "";
            return document.getElementById("pwd1").focus();
        }


        $.ajax({
            type : "POST",
            url : "/login/pwdChange_ing",
            data : {"userEmail": userEmail,"newPwd" : newPwd},
            success: function (data){

                if (data.code === 1){
                    alert(" 비밀번호가 성공적으로 바뀌었습니다. 회원가입 후 이용해주세요.")
                    window.location.href = "/login/loginForm";
                }else {
                    alert("다시 한번 시도해주세요.");
                }
            },
            error:function (XMLHttpRequest, textStatus, errorThrown){
                alert("통신 실패.")
            }
        })
    })

</script>

</body>

</html>